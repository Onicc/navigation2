
<!--
  This Behavior Tree replans the global path periodically at 1 Hz and it also has
  recovery actions specific to planning / control as well as general system issues.
  This will be continuous if a kinematically valid planner is selected.
-->
<root main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <RecoveryNode number_of_retries="6" name="NavigateRecovery">
      <PipelineSequence name="NavigateWithReplanning">
        <RateController hz="2.0">
          <Fallback name="PathSelection">
            <Sequence name="FollowPath">
              <NavigationStateComparison current_navigation_state="{navigation_state}" navigation_state="path"/>
              <Fallback name="ComputePathToPathAndSwitchState">
                <RecoveryNode number_of_retries="1" name="ComputePathToPath">
                  <PipelineSequence name="ComputePathThroughPoses">
                    <TruncatePathLocalToPoses input_path="{goal_path}" input_path_index="{goal_path_index}" output_path="{path_local}" output_goals="{goals}" output_path_index="{goal_path_index}" distance_forward="5.0" distance_backward="0.0" robot_frame="base_link"/>
                    <ComputePathThroughPoses goals="{goals}" path="{path}" planner_id="StraightLine"/>
                  </PipelineSequence>
                  <ClearEntireCostmap name="ClearGlobalCostmap-Context" service_name="global_costmap/clear_entirely_global_costmap"/>
                </RecoveryNode>
                <SetNavigationStateAction input_state="obstacle" output_state="{navigation_state}"/>
              </Fallback>
            </Sequence>
            <Sequence name="ObstacleNavigation">
              <NavigationStateComparison current_navigation_state="{navigation_state}" navigation_state="obstacle"/>
              <RecoveryWithOutputNode number_of_retries="10" retry_count="{replanning_count}" name="ComputePathToPath">
                <Sequence name="ComputePathToPose">
                  <ComputePathToPose goal="{goal_pose}" path="{path_local}" planner_id="Point"/>
                  <ComputePathToPose goal="{goal_pose}" path="{path}" planner_id="Navfn"/>
                </Sequence>
                <Sequence name="ClearCostmapAndChangePose">
                  <UpdateGoal input_path="{goal_path}" input_index="{goal_path_index}" output_goal="{goal_pose}" output_index="{goal_path_index_temp}" increment="2.0" replanning_count="{replanning_count}"/>
                  <ClearEntireCostmap name="ClearGlobalCostmap-Context" service_name="global_costmap/clear_entirely_global_costmap"/>
                </Sequence>
              </RecoveryWithOutputNode>
              <Fallback name="ComputePoseToPathAndSwitchState">
                <Inverter>
                  <GoalReached goal="{goal_pose}" robot_base_frame="base_link"/>
                </Inverter>
                <SetNavigationStateAction input_state="path" output_state="{navigation_state}"/>
              </Fallback>
              <!-- <SetGoalPathIndex input_index="{goal_path_index_temp}" output_index="{goal_path_index}"/> -->
            </Sequence>
          </Fallback>
        </RateController>
        <Sequence name="MonitorAndFollowPath">
          <!-- <PathLongerOnApproach path="{path}" prox_len="1.0" length_factor="1.2">
            <RetryUntilSuccessful num_attempts="1">
              <SequenceStar name="CancelingControlAndWait">
                <CancelControl name="ControlCancel"/>
                <Wait wait_duration="5"/>
              </SequenceStar>
            </RetryUntilSuccessful>
          </PathLongerOnApproach> -->
          <!-- <IsPathValid server_timeout="0.1" path="{path}"/>  -->
          <RecoveryNode number_of_retries="1" name="FollowPath">
            <FollowPath path="{path}" controller_id="FollowPath"/>
            <Sequence name="ClearingActions">
              <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap"/>
              <ClearEntireCostmap name="ClearGlobalCostmap-Context" service_name="global_costmap/clear_entirely_global_costmap"/>
            </Sequence>
          </RecoveryNode>
        </Sequence>
      </PipelineSequence>
      <ReactiveFallback name="RecoveryFallback">
        <GoalPathUpdated/>
        <RoundRobin name="RecoveryActions">
          <Sequence name="ClearingActions">
            <ClearEntireCostmap name="ClearLocalCostmap-Subtree" service_name="local_costmap/clear_entirely_local_costmap"/>
            <ClearEntireCostmap name="ClearGlobalCostmap-Subtree" service_name="global_costmap/clear_entirely_global_costmap"/>
          </Sequence>
          <!-- <Spin spin_dist="1.57"/> -->
          <Wait wait_duration="5"/>
          <!-- <BackUp backup_dist="0.30" backup_speed="0.05"/> -->
        </RoundRobin>
      </ReactiveFallback>
    </RecoveryNode>
  </BehaviorTree>
</root>
